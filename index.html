<div
  id="rec706492311908"
  class="r"
  style="padding-top: 90px; padding-bottom: 120px"
>
  <div class="t431">
    <div class="t-container"></div>
  </div>

  <style>
    #rec706492311908 .t431 .t431__th {
      border-width: 0px 0px 1px 0px;
      border-color: #000000;
    }

    #rec706492311908 .t431 .t431__tbody tr:nth-child(1) td {
      border-top: 0 !important;
    }

    #rec706492311908 .t431 .t431__td {
      border-width: 1px 0px;
      vertical-align: ;
      border-color: #d9d9d9;
      color: #4d4c4c;
    }

    #rec706492311908 .t431 .t431__oddrow {
      background: #ffffff;
    }

    #rec706492311908 .t431 .t431__evenrow {
      background: #eeeeee;
    }

    #rec706492311908 .t431 .t431__btnwrapper a {
      color: #ffffff;
      border: 0px solid #000000;
      background-color: #000000;
      border-radius: 21px;
      -moz-border-radius: 21px;
      -webkit-border-radius: 21px;
    }

    #rec706492311908 .t431__table th {
      border: 1px solid #d9d9d9;
    }

    #rec706492311908 .t431__table input::-webkit-outer-spin-button,
    #rec706492311908 .t431__table input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    #rec706492311908 .t431__table input[type="number"] {
      appearance: textfield;
    }
  </style>

  <script>
    // t_onReady(function () {
    // t_onFuncLoad("t431_init", function () {
    // t431_init(706492311908);
    // });
    // });

    const results = {};

    const MODEL_KEY = "MODEL";
    const DESCRIPTION_KEY = "DESCRIPTION";
    const SIZE_KEY = "SIZE";
    const AMOUNT_KEY = "AMOUNT";
    const PRISE_KEY = "PRISE";

    const SIZES = {
      [MODEL_KEY]: "20%",
      [DESCRIPTION_KEY]: "30%",
      [SIZE_KEY]: "15%",
      [AMOUNT_KEY]: "15%",
      [PRISE_KEY]: "20%",
    };

    const KEYS = {
      0: MODEL_KEY,
      1: DESCRIPTION_KEY,
      2: SIZE_KEY,
      3: AMOUNT_KEY,
      4: PRISE_KEY,
    };

    const STEP = 0.5;

    const AMOUNT_TOTAL_ID = `${AMOUNT_KEY}-total`;
    const PRISE_TOTAL_ID = `${PRISE_KEY}-total`;

    const data = mapIds([
      {
        title: "Извещатели малой дальности",
        header: ["Модель", "Описание", "Размер", "Количество", "Цена"],
        rows: [
          {
            model: "ДИА-2/16",
            description:
              "Датчик для систем автоматики, безынерционный, дальность связи до 3 м, Дальность регулируемая. Высота датчика от 0,5м ло 3 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 30х40мм.",
            prise: {
              0.5: 18000,
              1: 34000,
              1.5: 50000,
              2: 66000,
              2.5: 82000,
              3: 98000,
            },
          },
          {
            model: "ДИА-10/8",
            description:
              "Датчик охранный, безынерционный, дальность связи до 10 м, Дальность регулируемая. Использование в закрытых помещениях. Без защиты от солнечных помех. Высота датчика от 0,5м ло 4 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 30х40мм.",
            prise: {
              0.5: 30000,
              1: 58000,
              1.5: 86000,
              2: 114000,
              2.5: 142000,
              3: 170000,
            },
          },
          {
            model: "ДИА-10/16",
            description:
              "Датчик охранный, безынерционный, дальность связи до 10 м, Дальность регулируемая. Использование в закрытых помещениях. Без защиты от солнечных помех. Высота датчика от 0,5м ло 6 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 30х40мм.",
            prise: {
              0.5: 28000,
              1: 52000,
              1.5: 76000,
              2: 100000,
              2.5: 124000,
              3: 148000,
            },
          },
          {
            model: "ДИАС-10/16",
            description:
              "Датчик охранный, безынерционный, дальность связи до 10 м, Дальность регулируемая. Уличное исполнение. Температура от -30 до +55°С.100% защита от солнечных помех. Высота датчика от 0,5м ло 6 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 30х40мм.",
            prise: {
              0.5: 30000,
              1: 56000,
              1.5: 82000,
              2: 108000,
              2.5: 134000,
              3: 160000,
              3.5: 186000,
              4: 212000,
              4.5: 238000,
              5: 264000,
              5.5: 29000,
              6: 316000,
            },
          },
        ],
      },
      {
        title: "Извещатели средней дальности",
        rows: [
          {
            model: "ДИА-60/16",
            description:
              "Датчик охранный, безынерционный, дальность связи до 60 м, Дальность регулируемая. Использование в закрытых помещениях. Без защиты от солнечных помех. Высота датчика от 0,5м ло 6 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 60х40мм.",
            prise: {
              0.5: 30000,
              1: 56000,
              1.5: 82000,
              2: 108000,
              2.5: 134000,
              3: 160000,
              3.5: 186000,
              4: 212000,
              4.5: 238000,
              5: 264000,
              5.5: 29000,
              6: 316000,
            },
          },
          {
            model: "ДИАС-60/16",
            description:
              "Датчик охранный, безынерционный, дальность связи до 60 м, Дальность регулируемая. Уличное исполнение. Температура от -30 до +55°С.100% Защита от солнечных помех. Высота датчика от 0,5м ло 6 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 60х40мм.",
            prise: {
              0.5: 36000,
              1: 68000,
              1.5: 100000,
              2: 132000,
              2.5: 164000,
              3: 196000,
              3.5: 228000,
              4: 260000,
              4.5: 292000,
              5: 324000,
              5.5: 356000,
              6: 388000,
            },
          },
        ],
      },
      {
        title: "Извещатели большой дальности",
        rows: [
          {
            model: "ДИАС-100/16",
            description:
              "Датчик охранный, безынерционный, дальность связи до 100 м, Дальность регулируемая. Использование в закрытых помещениях. Без защиты от солнечных помех. Высота датчика от 0,5м ло 6 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 60х40мм.",
            prise: {
              0.5: 42000,
              1: 78000,
              1.5: 114000,
              2: 150000,
              2.5: 186000,
              3: 222000,
              3.5: 258000,
              4: 294000,
              4.5: 330000,
              5: 366000,
              5.5: 402000,
              6: 438000,
            },
          },
          {
            model: "ДИАС-150/16С",
            description:
              "Датчик охранный, безынерционный, дальность связи до 150 м, Дальность регулируемая. Уличное исполнение. Температура от -30 до +55°С.100% Защита от солнечных помех. Высота датчика от 0,5м ло 6 м. Шаг 0.5м. Расстояние между лучами 16см. Корпус 60х40мм.",
            prise: {
              0.5: 50000,
              1: 86000,
              1.5: 122000,
              2: 158000,
              2.5: 194000,
              3: 230000,
              3.5: 266000,
              4: 302000,
              4.5: 338000,
              5: 374000,
              5.5: 410000,
              6: 446000,
            },
          },
        ],
      },
      {
        title: "Запасные части, ремкомплекты",
        rows: [
          {
            model: "МП ДИА-2/16",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "МП ДИА-2/16",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "МП ДИА-10/8",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "МП ДИА-10/16",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "МП ДИАС-10/16",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "МП ДИА-60/16",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "МП ДИАС-100/16",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "МП ДИАС-150/16С",
            description: "Плата излучателей и приемников",
            prise: null,
          },
          {
            model: "PINP 3.8",
            description: "Плата управления",
            prise: null,
          },
        ],
      },
      {
        title: "Модули питания",
        rows: [
          {
            model: "Преобразователь 24/12",
            description: "― 24В(АС) на 12 В(DC) ― 3А",
            prise: 1800,
          },
          {
            model: "Преобразователь 48/12",
            description: "― 48В(АС) на 12 В(DC) ― 3А",
            prise: 1800,
          },
        ],
      },
    ]);

    function getDispatch(data) {
      return ({id, ...payload}) => {
        results[id] = {id, ...results[id], ...payload};

        if (results[id].prise === null) {
          results[id].total = 0;
        } else if (typeof results[id].prise === "number") {
          results[id].total = results[id].amount * results[id].prise;
        } else {
          results[id].total =
            results[id].amount * (results[id].prise[results[id].size] ?? 0);
        }

        rerender(results);
      };
    }

    const createTable = getCreateTable(data);
    const dispatch = getDispatch(data);

    const container = document.querySelector("#rec706492311908 .t431");
    if (container) {
      const tableElement = createTable(data);
      container.prepend(tableElement);
    }

    function getCreateTable(data) {
      const createTitle = getCreateTitle(data);
      const createHeader = getCreateHeader(data);
      const createBody = getCreateBody(data);
      const createFooter = getCreateFooter(data);

      return () => {
        const tableElement = document.createElement("table");
        tableElement.classList.add("t431__table");
        tableElement.setAttribute("width", "100%");

        data.forEach((row) => {
          // Создание заголовка. Пример: "Извещатели малой дальности"
          if (row.title) {
            const thead = createTitle(row);
            tableElement.appendChild(thead);
          }

          // Создание шапки таблицы. Пример: "Модель", "Описание", "Размер", "Количество", "Цена"
          if (row.header && row.header.length) {
            const thead = createHeader(row);
            tableElement.appendChild(thead);
          }

          // Создание строк таблицы
          if (row.rows && row.rows.length) {
            const tbody = createBody(row);
            tableElement.appendChild(tbody);
          }
        });

        const tfooter = createFooter();
        tableElement.appendChild(tfooter);

        return tableElement;
      };
    }

    function getCreateTitle(data) {
      return (row) => {
        const thead = document.createElement("thead");
        thead.classList.add("t431__thead");

        const tr = document.createElement("tr");
        const th = document.createElement("th");
        th.setAttribute("colspan", "5");
        th.classList.add("t431__th");
        th.classList.add("t-title");
        th.innerText = row.title;
        tr.appendChild(th);
        thead.appendChild(tr);

        return thead;
      };
    }

    function getCreateHeader(data) {
      return (row) => {
        const thead = document.createElement("thead");
        thead.classList.add("t431__thead");

        const tr = document.createElement("tr");
        row.header.forEach((text, index) => {
          const th = document.createElement("th");
          th.setAttribute("width", SIZES[KEYS[index]]);
          th.classList.add("t431__th");
          th.classList.add("t-title");
          th.innerText = text;
          tr.appendChild(th);
        });

        thead.appendChild(tr);
        return thead;
      };
    }

    function getCreateBody(data) {
      const createSizeSelect = getCreateSizeSelect(data);
      const createAmountInput = getCreateAmountInput(data);

      return (data) => {
        const tbody = document.createElement("tbody");
        tbody.classList.add("t431__tbody");

        data.rows.forEach((currentRow) => {
          dispatch({
            id: currentRow.id,
            prise: currentRow.prise,
            size: null,
            amount: null,
          });

          const tr = document.createElement("tr");
          tr.setAttribute("id", currentRow.id);

          // Модель
          const tdModel = document.createElement("td");
          tdModel.classList.add("model");
          tdModel.classList.add("t431__td");
          tdModel.classList.add("t-text");
          tdModel.innerHTML = currentRow.model;

          // Описание
          const tdDescription = document.createElement("td");
          tdDescription.classList.add("description");
          tdDescription.classList.add("t431__td");
          tdDescription.classList.add("t-text");
          tdDescription.innerHTML = currentRow.description;

          // Размер
          const tdSize = document.createElement("td");
          tdSize.classList.add("size");
          tdSize.classList.add("t431__td");
          tdSize.classList.add("t-text");
          const select = createSizeSelect(currentRow);
          tdSize.appendChild(select);

          // Количество
          const tdAmount = document.createElement("td");
          tdAmount.classList.add("amount");
          tdAmount.classList.add("t431__td");
          tdAmount.classList.add("t-text");
          const amountInput = createAmountInput(currentRow);
          tdAmount.appendChild(amountInput);

          // Цена
          const tdPrise = document.createElement("td");
          tdPrise.classList.add("prise");
          tdPrise.classList.add("t431__td");
          tdPrise.classList.add("t-text");
          tdPrise.innerHTML =
            results[currentRow.id].total > 0
              ? results[currentRow.id].total
              : "";

          tr.appendChild(tdModel);
          tr.appendChild(tdDescription);
          tr.appendChild(tdSize);
          tr.appendChild(tdAmount);
          tr.appendChild(tdPrise);

          tbody.appendChild(tr);
        });

        return tbody;
      };
    }

    function getCreateFooter(data) {
      return () => {
        const tbody = document.createElement("tbody");
        tbody.classList.add("t431__tbody");

        const tr = document.createElement("tr");

        data[0].header.forEach((_, index) => {
          const td = document.createElement("td");
          td.setAttribute("width", SIZES[KEYS[index]]);
          td.classList.add("t431__td");
          td.classList.add("t-text");
          td.setAttribute("id", `${KEYS[index]}-total`);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
        return tbody;
      };
    }

    function getCreateSizeSelect(data) {
      return (row) => {
        if (row.prise === null || typeof row.prise === "number") {
          return document.createElement("span");
        }

        const select = document.createElement("select");
        select.setAttribute("data-id", row.id);
        addEventListener(select, "change", "size");

        const sizes = Object.keys(row.prise ?? {});

        if (!sizes.length) {
          return select;
        }

        const option = document.createElement("option");
        option.setAttribute("selected", "true");
        option.value = "";
        option.text = "";
        select.appendChild(option);

        sizes
          .map((size) => Number(size))
          .sort((a, b) => a - b)
          .forEach((size) => {
            const option = document.createElement("option");
            option.value = String(size);
            option.text = size;
            select.appendChild(option);
          });

        return select;
      };
    }

    function getCreateAmountInput(data) {
      return (row) => {
        const input = document.createElement("input");
        input.setAttribute("data-id", row.id);
        addEventListener(input, "input", "amount");
        input.type = "number";
        input.min = 0;
        return input;
      };
    }

    function rerender(results) {
      const keys = Object.keys(results);

      let amountTotal = 0;
      let priseTotal = 0;

      // Обновление цен по строкам
      keys.forEach((key) => {
        amountTotal += results[key].amount;
        priseTotal += results[key].total;

        const priseEl = document.querySelector(`#${key} .prise`);
        if (priseEl) {
          priseEl.innerHTML = results[key].total > 0 ? results[key].total : "";
        }
      });

      const amountTotalEl = document.getElementById(`${AMOUNT_KEY}-total`);
      if (amountTotalEl) {
        amountTotalEl.innerHTML = amountTotal > 0 ? amountTotal : "";
      }

      const priseTotalEl = document.getElementById(`${PRISE_KEY}-total`);
      if (priseTotalEl) {
        priseTotalEl.innerHTML = priseTotal > 0 ? priseTotal : "";
      }
    }

    function mapIds(table) {
      return table.map((row) => ({
        ...row,
        rows: row.rows.map((currentRow) => ({
          ...currentRow,
          id: currentRow.model.replaceAll("/", "-").replaceAll(/\s+|\./g, ""),
        })),
      }));
    }

    function addEventListener(element, eventType, field) {
      element.addEventListener(eventType, (event) => {
        const value = event.target.value;
        const id = event.target.dataset.id;
        dispatch({id, [field]: Number(value)});
      });
    }
  </script>
</div>
